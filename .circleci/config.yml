version: 2

machine:
  node:
    version: 12.16.2

dependencies:
  pre:
    - 'echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc'

jobs:
  test:
    docker:
      - image: circleci/ruby:2.4.2-jessie-node
    steps:
      - checkout
      - run: rm -rf $CIRCLE_ARTIFACTS/coverage
      - run: npm run lint
      - run: npm run test
      - run: cp -r coverage $CIRCLE_ARTIFACTS
      - run: npm run coverage

  build:
    docker:
      - image: circleci/ruby:2.4.2-jessie-node
    steps:
      - checkout
      - run: npm run build:node && npm run build:browser

workflows:
  version: 2
  build_and_test:
    jobs:
      - test
      - build
